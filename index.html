<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Good Morning</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik+Bubbles&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --ghibli-sky: #A1D2EB;      /* æŒ‡å®šçš„æ·ºè—åº•è‰² */
            --ghibli-sun: #F4EBC1;
            --ghibli-earth: #8B5E3C;
            --ghibli-cream: #FFFBE8;
            --text-dark: #4A3B2F;
            
            --font-main: 'ZCOOL KuaiLe', cursive; 
            --font-en: 'Rubik Bubbles', cursive; 
        }

        body {
            font-family: var(--font-main);
            color: var(--text-dark);
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));

            /* ==========================================================
               ğŸ¨ èƒŒæ™¯è¨­å®š (åº•è‰² + åŠé€æ˜åœ–æ¡ˆ)
               ========================================================== */
            
            /* 1. è¨­å®šåº•è‰² (æ·ºè—) */
            background-color: var(--ghibli-sky);

            /* 2. è¨­å®šåœ–æ¡ˆ */
            /* é€™è£¡ä½¿ç”¨ CSS ç•«å‡ºåŠé€æ˜ç™½é»ï¼Œä¿è­‰æœƒé€å‡ºåº•è‰² */
            /* å¦‚æœè¦ç”¨è‡ªå·±çš„åœ–ï¼Œè«‹æ”¹ç‚º: background-image: url('your-transparent-image.png'); */
            background-image: url('bg2.png');          
          
            background-size: 300px;
            background-repeat: repeat;
        }

        header { 
            width: 100%;
            margin-bottom: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }

        .header-top-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* å°å¤ªé™½ (åŠ æ·±é¡è‰²ç‰ˆ) */
        .sun-mascot-small { 
            width: 60px; height: 60px; 
            animation: spin-slow 16s linear infinite; 
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); 
        }

        h1 {
            color: #FFF; 
            margin: 0;
            font-size: 2.8rem;
            font-family: var(--font-en); 
            text-shadow: 3px 3px 0px #4A90E2, 5px 5px 5px rgba(0,0,0,0.2);
            letter-spacing: 2px;
            line-height: 1.2;
        }

        /* ğŸ“Š ç‹€æ…‹åˆ—ï¼šåŒ…å«æ˜Ÿæ˜Ÿå’Œæ™‚é˜ */
        .status-bar {
            display: flex;
            align-items: stretch; /* è®“å…©å€‹æ¡†æ¡†ç­‰é«˜ */
            justify-content: center;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }

        /* æ˜Ÿæ˜Ÿè¨ˆæ•¸å™¨ */
        .star-widget {
            flex: 1;
            background: var(--ghibli-sun);
            padding: 10px;
            border-radius: 20px;
            box-shadow: 0 4px 0 #D9CFA0, 0 5px 10px rgba(0,0,0,0.1);
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border: 3px solid var(--ghibli-earth);
            color: #D35400;
        }
        .star-count-text { font-family: var(--font-en); font-weight: bold; margin-left: 5px; }

        /* â° é¡æ¯”æ™‚é˜å®¹å™¨ */
        .clock-widget {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 4px 0 rgba(139, 94, 60, 0.3), 0 5px 10px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--ghibli-earth);
        }

        /* SVG æ™‚é˜æœ¬é«” */
        .analog-clock {
            width: 70px;
            height: 70px;
        }
        
        /* æ•¸å­—æ™‚é–“æ–‡å­— */
        .digital-time {
            font-family: var(--font-en);
            color: var(--text-dark);
            font-size: 1rem;
            margin-top: -5px;
        }

        /* æ™‚é˜æŒ‡é‡è½‰è»¸ä¸­å¿ƒ */
        .clock-center { fill: #8B5E3C; }
        /* æŒ‡é‡æ¨£å¼ */
        .hand { transform-origin: 50% 50%; stroke-linecap: round; }
        .hand-hour { stroke: #4A3B2F; stroke-width: 4; }
        .hand-min { stroke: #8B5E3C; stroke-width: 3; }
        .hand-sec { stroke: #D35400; stroke-width: 1.5; }

        /* ğŸ“œ éŠæˆ²å¡ç‰‡ */
        .game-card {
            background: var(--ghibli-cream);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            padding: 25px 20px;
            border-radius: 25px;
            width: 100%; max-width: 450px;
            display: flex; flex-direction: column; align-items: center;
            border: 6px solid var(--ghibli-earth);
            box-shadow: 0 10px 0 rgba(139, 94, 60, 0.3), 0 15px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
        }

        .level-sticker-container { height: 140px; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
        .svg-icon { width: 130px; height: 130px; filter: drop-shadow(0 8px 5px rgba(0,0,0,0.1)); animation: bounce-gentle 3s infinite ease-in-out; }
        .level-sticker { font-size: 6.5rem; line-height: 1; filter: drop-shadow(0 6px 4px rgba(0,0,0,0.1)); animation: bounce-gentle 3s infinite ease-in-out; }
        .blue-bag { filter: hue-rotate(210deg) drop-shadow(0 6px 4px rgba(0,0,0,0.1)) !important; }

        .level-title { font-size: 2.2rem; color: var(--text-dark); margin: 15px 0; text-align: center; }
        
        /* ğŸ’§ é€²åº¦æ¢ */
        .progress-bar-wrap { 
            width: 100%; height: 30px; 
            background: #F0F4F8; border-radius: 15px; 
            border: 4px solid var(--ghibli-earth);
            margin: 10px 0; overflow: hidden; 
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.1);
        }
        .progress-bar { 
            height: 100%; width: 100%; 
            background: linear-gradient(to bottom, #A1D2EB, #8FBED8); 
            transition: width 1s linear; 
            border-radius: 10px;
            border-right: 3px solid rgba(255,255,255,0.5);
        }
        
        .timer-text { font-family: var(--font-en); font-size: 1.6rem; color: #8D7B68; margin-bottom: 25px; }

        /* ğŸ”² æ–¹å½¢ GO æŒ‰éˆ• */
        .btn-go {
            width: 150px; height: 130px; border-radius: 20px;
            background: linear-gradient(to bottom, #D4A373 0%, #B38253 100%);
            border: 5px solid #8B5E3C;
            color: #FFFBE8;
            font-family: var(--font-en); font-size: 3rem;
            cursor: pointer;
            box-shadow: 0 12px 0 #6D4C41, 0 15px 20px rgba(0,0,0,0.3), inset 0 2px 3px rgba(255,255,255,0.3);
            transition: all 0.15s;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            -webkit-user-select: none; user-select: none;
        }
        .btn-go:active { transform: translateY(10px) scale(0.98); box-shadow: 0 2px 0 #6D4C41, inset 0 5px 10px rgba(0,0,0,0.2); }

        .btn-go.finish {
            width: 100%; height: auto; border-radius: 25px;
            background: linear-gradient(to bottom, #87C158 0%, #6EA343 100%);
            border: 5px solid #557D36;
            font-size: 0; padding: 18px 0;
            box-shadow: 0 10px 0 #426628, 0 15px 20px rgba(0,0,0,0.2), inset 0 2px 3px rgba(255,255,255,0.3);
        }
        .btn-go.finish:active { transform: translateY(10px); box-shadow: 0 2px 0 #426628; }
        
        .check-icon { width: 55px; height: 55px; fill: none; stroke: #FFFBE8; stroke-width: 6; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)); animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* æœˆæ›† */
        .calendar-card {
            width: 100%; max-width: 450px;
            background: var(--ghibli-cream);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
            border-radius: 25px; padding: 20px;
            border: 5px solid var(--ghibli-earth);
            box-shadow: 0 8px 0 rgba(139, 94, 60, 0.3), 0 15px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .calendar-header { text-align: center; font-size: 1.6rem; color: var(--text-dark); margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day {
            aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.5); border-radius: 12px; font-family: var(--font-en); color: #A09383; font-size: 1.1rem;
            border: 2px solid transparent;
        }
        .cal-day.done { background: var(--ghibli-sun); color: #D35400; border: 3px solid #D9CFA0; font-size: 1.3rem; box-shadow: 0 3px 0 #D9CFA0; transform: rotate(-2deg); }
        .cal-day.early { background: #FFD700; color: #FFFBE8; border: 3px solid #DAA520; box-shadow: 0 3px 0 #DAA520; transform: rotate(2deg); }
        .cal-day.today { border: 3px dashed var(--ghibli-sky); }

        .footer-tools { text-align: center; margin-top: 10px; }
        .btn-reset { background: none; border: none; color: #8D7B68; text-decoration: underline; font-family: var(--font-main); cursor: pointer; font-size: 1rem;}

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; display: none; }
        
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop-in { 0% { transform: scale(0) rotate(-20deg); } 100% { transform: scale(1) rotate(0deg); } }
    </style>
</head>
<body>

    <header>
        <div class="header-top-row">
            <svg class="sun-mascot-small" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g stroke="#FF9F43" stroke-width="8" stroke-linecap="round">
                    <line x1="50" y1="10" x2="50" y2="2"/> <line x1="50" y1="90" x2="50" y2="98"/>
                    <line x1="90" y1="50" x2="98" y2="50"/> <line x1="10" y1="50" x2="2" y2="50"/>
                    <line x1="78" y1="22" x2="84" y2="16"/> <line x1="22" y1="78" x2="16" y2="84"/>
                    <line x1="78" y1="78" x2="84" y2="84"/> <line x1="22" y1="22" x2="16" y2="16"/>
                </g>
                <circle cx="50" cy="50" r="30" fill="#FFD700" stroke="#FF9F43" stroke-width="3"/>
                <circle cx="40" cy="45" r="3" fill="#4A3B2F"/> <circle cx="60" cy="45" r="3" fill="#4A3B2F"/>
                <circle cx="35" cy="52" r="4" fill="#FF9A9E" opacity="0.8"/> <circle cx="65" cy="52" r="4" fill="#FF9A9E" opacity="0.8"/>
                <path d="M42 55 Q50 62 58 55" fill="none" stroke="#4A3B2F" stroke-width="2" stroke-linecap="round"/>
            </svg>
            
            <h1>Good Morning</h1>
        </div>

        <div class="status-bar">
            <div class="star-widget">
                <span class="widget-icon">â­</span>
                <span class="star-count-text" id="stars-count">0</span>
            </div>
            
            <div class="clock-widget">
                <svg class="analog-clock" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#F4EBC1" stroke="#8B5E3C" stroke-width="3" />
                    <line x1="50" y1="10" x2="50" y2="15" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="50" y1="90" x2="50" y2="85" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="10" y1="50" x2="15" y2="50" stroke="#8B5E3C" stroke-width="2" />
                    <line x1="90" y1="50" x2="85" y2="50" stroke="#8B5E3C" stroke-width="2" />
                    
                    <line id="hand-hour" class="hand hand-hour" x1="50" y1="50" x2="50" y2="25" />
                    <line id="hand-min" class="hand hand-min" x1="50" y1="50" x2="50" y2="15" />
                    <line id="hand-sec" class="hand hand-sec" x1="50" y1="50" x2="50" y2="12" />
                    
                    <circle cx="50" cy="50" r="3" fill="#8B5E3C" />
                </svg>
                <div class="digital-time" id="digital-clock">--:--</div>
            </div>
        </div>
    </header>

    <div class="game-card">
        <div class="level-sticker-container" id="level-icon-container">
            <div id="default-sun"></div>
        </div>
        
        <h2 class="level-title" id="level-name">å‚…æ—»èµ«! GOGO!</h2>
        
        <div class="progress-bar-wrap" id="progress-wrap">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="timer-text" id="timer">æº–å‚™å¥½äº†å—ï¼Ÿ</div>
        
        <button class="btn-go" id="action-btn" onclick="handleAction()">GO!</button>
    </div>

    <div class="calendar-card">
        <div class="calendar-header" id="cal-month-title">æœˆæ›†</div>
        <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <div class="footer-tools">
        <button class="btn-reset" onclick="clearHistory()">é‡è¨­ç´€éŒ„</button>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        // SVG å®šç¾©
        const cuteSunSVG = `
        <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g class="sun-rays" stroke="#FF9F43" stroke-width="6" stroke-linecap="round">
                <line x1="50" y1="5" x2="50" y2="15"/> <line x1="50" y1="85" x2="50" y2="95"/>
                <line x1="5" y1="50" x2="15" y2="50"/> <line x1="85" y1="50" x2="95" y2="50"/>
                <line x1="18" y1="18" x2="25" y2="25"/> <line x1="75" y1="75" x2="82" y2="82"/>
                <line x1="82" y1="18" x2="75" y2="25"/> <line x1="18" y1="82" x2="25" y2="75"/>
            </g>
            <circle cx="50" cy="50" r="32" fill="#FFD700" stroke="#FF9F43" stroke-width="4"/>
            <circle cx="38" cy="45" r="4" fill="#4A3B2F"/> <circle cx="62" cy="45" r="4" fill="#4A3B2F"/>
            <ellipse cx="32" cy="55" rx="5" ry="3" fill="#FF9A9E" opacity="0.8"/>
            <ellipse cx="68" cy="55" rx="5" ry="3" fill="#FF9A9E" opacity="0.8"/>
            <path d="M40 58 Q50 68 60 58" fill="none" stroke="#4A3B2F" stroke-width="3" stroke-linecap="round"/>
        </svg>`;

        const boyWithBagSVG = `
        <svg class="svg-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <rect x="15" y="35" width="25" height="30" rx="4" fill="#A1D2EB" stroke="#FFFBE8" stroke-width="3"/>
            <rect x="15" y="35" width="25" height="12" rx="2" fill="#8FBED8" stroke="#FFFBE8" stroke-width="3"/>
            <rect x="35" y="35" width="30" height="35" rx="6" fill="#D4A373" stroke="#FFFBE8" stroke-width="3"/>
            <circle cx="50" cy="22" r="14" fill="#FCEEA7" stroke="#FFFBE8" stroke-width="3"/>
            <circle cx="54" cy="20" r="2" fill="#4A3B2F"/> <circle cx="46" cy="20" r="2" fill="#4A3B2F"/>
            <path d="M48 26 Q50 28 52 26" stroke="#4A3B2F" stroke-width="2" fill="none" stroke-linecap="round"/>
            <rect x="40" y="70" width="8" height="20" rx="3" fill="#8B5E3C"/>
            <rect x="52" y="70" width="8" height="20" rx="3" fill="#8B5E3C"/>
            <path d="M60 40 Q75 30 70 20" stroke="#FCEEA7" stroke-width="7" stroke-linecap="round" fill="none"/>
        </svg>`;

        const checkIconSVG = `
        <svg class="check-icon" viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>`;

        const levels = [
            { name: "ä¸Šå»æ‰€", icon: "ğŸš½", type: "emoji", style: "" },
            { name: "åˆ·ç‰™", icon: "ğŸª¥", type: "emoji", style: "" },
            { name: "æ›è¡£æœ", icon: "ğŸ‘•", type: "emoji", style: "" },
            { name: "æ”¶æ›¸åŒ…", icon: "ğŸ’", type: "emoji", style: "blue-bag" }, 
            { name: "ç©¿è¥ªå­é‹å­", icon: "ğŸ§¦ğŸ‘Ÿ", type: "emoji", style: "" },
            { name: "Ready!", icon: boyWithBagSVG, type: "html", style: "" } 
        ];

        let currentLevelIndex = 0;
        let isRunning = false;
        let startTime = 0;
        let timerInterval;
        let totalStars = 0;
        let gameFinished = false;
        const TIME_LIMIT = 300; 

        const levelNameEl = document.getElementById('level-name');
        const levelIconContainer = document.getElementById('level-icon-container');
        const defaultSunEl = document.getElementById('default-sun');
        const timerEl = document.getElementById('timer');
        const progressBar = document.getElementById('progress-bar');
        const btnEl = document.getElementById('action-btn');
        const starsCountEl = document.getElementById('stars-count');
        const calGrid = document.getElementById('calendar-grid');
        const calTitle = document.getElementById('cal-month-title');
        
        // æ™‚é˜æŒ‡é‡å…ƒç´ 
        const handHour = document.getElementById('hand-hour');
        const handMin = document.getElementById('hand-min');
        const handSec = document.getElementById('hand-sec');
        const digitalClock = document.getElementById('digital-clock');

        defaultSunEl.innerHTML = cuteSunSVG;
        loadStars();
        renderCalendar(); 
        updateClock(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
        setInterval(updateClock, 1000); // æ¯ç§’æ›´æ–°æ™‚é˜

        function updateClock() {
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();

            // æ•¸ä½é¡¯ç¤º
            digitalClock.textContent = now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute:'2-digit' });

            // æŒ‡é‡è§’åº¦è¨ˆç®—
            // ç§’é‡ï¼šæ¯ç§’ 6 åº¦
            const secDeg = s * 6;
            // åˆ†é‡ï¼šæ¯åˆ† 6 åº¦ + æ¯ç§’ 0.1 åº¦
            const minDeg = m * 6 + s * 0.1;
            // æ™‚é‡ï¼šæ¯æ™‚ 30 åº¦ + æ¯åˆ† 0.5 åº¦
            const hourDeg = (h % 12) * 30 + m * 0.5;

            handSec.style.transform = `rotate(${secDeg}deg)`;
            handMin.style.transform = `rotate(${minDeg}deg)`;
            handHour.style.transform = `rotate(${hourDeg}deg)`;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const cleanText = text.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{200D}ï¼š]/gu, '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = 'zh-TW'; utterance.rate = 1.1; utterance.pitch = 1.4;
                window.speechSynthesis.speak(utterance);
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updateStars(count) {
            totalStars += count;
            starsCountEl.textContent = totalStars;
            localStorage.setItem('beibei_total_stars', totalStars);
            starsCountEl.parentElement.style.transform = "scale(1.2)";
            setTimeout(() => starsCountEl.parentElement.style.transform = "scale(1)", 300);
        }

        function loadStars() {
            totalStars = parseInt(localStorage.getItem('beibei_total_stars') || "0");
            starsCountEl.textContent = totalStars;
        }

        function handleAction() {
            if (gameFinished) { location.reload(); return; }
            if (!isRunning) { startLevel(); } else { finishLevelAndAutoStartNext(); }
        }

        function startLevel() {
            if (currentLevelIndex >= levels.length) return;
            isRunning = true;
            startTime = Date.now();
            const lvl = levels[currentLevelIndex];
            
            levelNameEl.textContent = lvl.name;
            speak(lvl.name);

            if (lvl.type === 'html') {
                levelIconContainer.innerHTML = lvl.icon;
            } else {
                let className = "level-sticker";
                if (lvl.style) className += " " + lvl.style;
                levelIconContainer.innerHTML = `<div class="${className}">${lvl.icon}</div>`;
            }

            btnEl.innerHTML = checkIconSVG;
            btnEl.classList.add('finish');
            
            progressBar.style.width = '100%';
            progressBar.style.background = 'linear-gradient(to bottom, #A1D2EB, #8FBED8)';

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = TIME_LIMIT - elapsed;
                
                timerEl.textContent = formatTime(elapsed);
                const percentage = Math.max(0, (remaining / TIME_LIMIT) * 100);
                progressBar.style.width = percentage + '%';

                if (percentage < 30) {
                    progressBar.style.background = 'linear-gradient(to bottom, #FF9AA2, #FFB7C5)';
                }

                if (elapsed > TIME_LIMIT) { timerEl.style.color = '#D35400'; } else { timerEl.style.color = '#8D7B68'; }
            }, 1000);
        }

        function finishLevelAndAutoStartNext() {
            clearInterval(timerInterval);
            const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            let starsEarned = 0;
            if (elapsedSeconds <= TIME_LIMIT) {
                starsEarned = 1;
                const savedSeconds = TIME_LIMIT - elapsedSeconds;
                const speedBonus = Math.floor(savedSeconds / 60);
                starsEarned += speedBonus;
                updateStars(starsEarned);
            }
            currentLevelIndex++;
            if (currentLevelIndex < levels.length) { startLevel(); } else { endGame(); }
        }

        function endGame() {
            isRunning = false;
            gameFinished = true;
            const now = new Date();
            const targetTime = new Date();
            targetTime.setHours(6, 50, 0);

            let isEarlyBird = false;
            let bonusText = "";
            if (now < targetTime) {
                updateStars(5);
                isEarlyBird = true;
                bonusText = "æ—©é³¥ +5 é¡†æ˜Ÿï¼";
            }

            saveDailyRecord(isEarlyBird);

            levelNameEl.textContent = "æŒ‘æˆ°æˆåŠŸï¼";
            levelIconContainer.innerHTML = `<div class="level-sticker">ğŸ‰</div>`;
            timerEl.textContent = `å¤ªæ£’äº†ï¼ ${bonusText}`;
            document.querySelector('.progress-bar-wrap').style.display = 'none';
            
            btnEl.innerHTML = "æ˜å¤©è¦‹";
            btnEl.style.fontSize = "1.8rem";
            btnEl.style.background = "linear-gradient(to bottom, #E0E0E0, #D0D0D0)";
            btnEl.style.border = "5px solid #A0A0A0";
            btnEl.style.boxShadow = "0 10px 0 #808080, 0 15px 20px rgba(0,0,0,0.1)";
            btnEl.style.color = "#666";
            btnEl.classList.remove('finish');
            
            speak(`æ­å–œï¼ç²å¾—äº† ${totalStars} é¡†æ˜Ÿæ˜Ÿï¼`);
            startConfetti();
        }

        function saveDailyRecord(isEarly) {
            const today = new Date();
            const dateKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            let calendarData = JSON.parse(localStorage.getItem('beibei_calendar') || "{}");
            calendarData[dateKey] = { done: true, early: isEarly };
            localStorage.setItem('beibei_calendar', JSON.stringify(calendarData));
            renderCalendar();
        }

        function renderCalendar() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            calTitle.textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay();
            let calendarData = JSON.parse(localStorage.getItem('beibei_calendar') || "{}");
            let html = '';
            for (let i = 0; i < firstDayIndex; i++) html += `<div></div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const record = calendarData[dateKey];
                const isToday = (day === now.getDate());
                let classes = 'cal-day';
                let content = day;
                if (isToday) classes += ' today';
                if (record) {
                    if (record.early) { classes += ' done early'; content = 'â­'; } 
                    else { classes += ' done'; content = 'âœ“'; }
                }
                html += `<div class="${classes}">${content}</div>`;
            }
            calGrid.innerHTML = html;
        }

        function clearHistory() {
            if(confirm("è¦æ¸…é™¤æ‰€æœ‰æ˜Ÿæ˜Ÿå’Œæœˆæ›†è²¼ç´™å—ï¼Ÿ")) {
                localStorage.removeItem('beibei_calendar');
                localStorage.removeItem('beibei_total_stars');
                location.reload();
            }
        }

        function startConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.style.display = 'block';
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const pieces = [];
            const colors = ['#A1D2EB', '#F4EBC1', '#87C158', '#FFD1DC'];
            for (let i = 0; i < 150; i++) {
                pieces.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 12 + 8,
                    speed: Math.random() * 4 + 2,
                    rotation: Math.random() * 360
                });
            }
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(0, 0, p.size/2, 0, 2 * Math.PI); ctx.fill();
                    ctx.restore();
                    p.y += p.speed; p.rotation += p.speed * 1.5;
                    if (p.y > canvas.height) p.y = -20;
                });
                requestAnimationFrame(draw);
            }
            draw();
            setTimeout(() => canvas.style.display = 'none', 5000);
        }
    </script>
</body>
</html>

